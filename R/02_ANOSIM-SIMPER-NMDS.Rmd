---
output: html_document
---

```{r}
set.seed(20220708)
```


Separate explanatory variables from species  

```{r}
# species matrices
sqrt_spp <- select(sqrt_sub, Abudefduf.saxatilis:ones)
log_spp <- select(log_sub, Abudefduf.saxatilis:ones)

# explanatory will be the same for both data frames; they have the same rows
expl <- select(sqrt_sub, -(Abudefduf.saxatilis:ones))
```




***  

### ANOSIM  


#### Overall for `r seas`  

```{r}
ano_sqrt <- anosim(sqrt_spp, grouping = expl$habitat_type,
               distance = "bray", permutations = how(blocks = expl$year_season,
                                                     nperm = 999))

ano_log <- anosim(log_spp, grouping = expl$habitat_type,
               distance = "bray", permutations = how(blocks = expl$year_season,
                                                     nperm = 999))


ano_unrestricted <- anosim(sqrt_spp, grouping = expl$habitat_type,
                           distance = "bray", permutations = 999)

```


Double-check to see if restricting permutations changed anything here.  

```{r}
ano_sqrt
ano_unrestricted  
```



#### Pairwise between habitats in `r seas`  

```{r}
pairs <- t(combn(unique(expl$habitat_type), m = 2))
```


```{r}
pair <- character()
n <- numeric()
ano_R_sqrt <- numeric()
ano_p_sqrt <- numeric()
ano_R_log <- numeric()
ano_p_log <- numeric()
densplots <- list()

for(i in 1:nrow(pairs)){
    # which rows are in this pair  
    indcs <- which(expl$habitat_type %in% pairs[i, ])
    
    # subset data frames
    sqrt_spp_pr <- sqrt_spp[indcs, ]
    log_spp_pr <- log_spp[indcs, ]
    expl_pr <- expl[indcs, ]
    
    # run anosims  
    ano_pr_sqrt <- anosim(sqrt_spp_pr, grouping = expl_pr$habitat_type,
                          distance = "bray", permutations = how(blocks = expl_pr$year_season,
                                                                nperm = 999))

    ano_pr_log <- anosim(log_spp_pr, grouping = expl_pr$habitat_type,
                          distance = "bray", permutations = how(blocks = expl_pr$year_season,
                                                                nperm = 999))
    
    # store outputs
    pair[i] <- paste(pairs[i, ], collapse = ", ")
    n[i] <- nrow(expl_pr)
    ano_R_sqrt[i] <- ano_pr_sqrt$statistic
    ano_p_sqrt[i] <- ano_pr_sqrt$signif
    ano_R_log[i] <- ano_pr_log$statistic
    ano_p_log[i] <- ano_pr_log$signif
    
    # print the density plot of permutations  
    perm <- permustats(ano_pr_sqrt)
    samp <- glue("Sample: R = ", {round(ano_pr_sqrt$statistic, 3)}, "; p = ",
             {round(ano_pr_sqrt$signif, 4)})
    p <- densityplot(perm, main = pair[i],
            xlab = "R (permuted values)",
            ylab = "density",
            strip = FALSE,
            sub = samp)
    densplots[[i]] <- p
   
}
```


```{r}
outs <- data.frame(pair, ano_R_sqrt, ano_p_sqrt, ano_R_log, ano_p_log, n) %>% 
    arrange(desc(ano_R_sqrt))
outs$season <- seas

overall <- data.frame(
    pair = "OVERALL",
    ano_R_sqrt = ano_sqrt$statistic,
    ano_p_sqrt = ano_sqrt$signif,
    ano_R_log = ano_log$statistic,
    ano_p_log = ano_log$signif,
    n = nrow(expl),
    season = seas
)

all <- bind_rows(overall, outs)

knitr::kable(all, digits = 4)

# save data frame to csv or .rds??

```

#### Density plots of permutations  

```{r}
samp <- glue("Sample: R = ", {round(ano_sqrt$statistic, 3)}, "; p = ",
             {round(ano_sqrt$signif, 4)})
perm <- permustats(ano_sqrt)
densityplot(perm, 
            main = paste("OVERALL,", seas),
            xlab = "R (permuted values)",
            ylab = "density",
            strip = FALSE,
            sub = samp)
```


```{r, fig.width = 8, fig.height = 16}
# print density plots
print(densplots[[1]], split = c(1, 1, 2, 5), more = TRUE)
print(densplots[[2]], split = c(2, 1, 2, 5), more = TRUE)
print(densplots[[3]], split = c(1, 2, 2, 5), more = TRUE)
print(densplots[[4]], split = c(2, 2, 2, 5), more = TRUE)
print(densplots[[5]], split = c(1, 3, 2, 5), more = TRUE)
print(densplots[[6]], split = c(2, 3, 2, 5), more = TRUE)
print(densplots[[7]], split = c(1, 4, 2, 5), more = TRUE)
print(densplots[[8]], split = c(2, 4, 2, 5), more = TRUE)
print(densplots[[9]], split = c(1, 5, 2, 5), more = TRUE)
print(densplots[[10]], split = c(2, 5, 2, 5))
```



***  

### SIMPER  

#### Overall for season  


#### Pairwise between habitats  


***  

### NMDS  

#### Scree Plot  

How many axes should be used?  


#### run with 2 axes  


#### run with 3 axes  


#### Shepard plots and stress values  